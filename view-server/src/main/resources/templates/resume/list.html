<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì´ë ¥ì„œ ê´€ë¦¬</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="/static/sidebar/js/side-bar.js"></script>
  <link rel="stylesheet" href="/static/resume/css/list.css">
  <script src="../../static/javascript/utils/axios.js"></script>
  <script src="../../static/javascript/utils/imageUtil.js"></script>
  <script src="/static/common/javascript/common.js"></script>
</head>
<body>
<div class="container">
  <!-- í—¤ë” -->
  <header th:replace="/layout/header :: headerFragment"></header>

  <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
  <nav th:replace="/layout/navbar :: navbarFragment"></nav>

  <div class="main">
    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar" th:replace="/layout/sidebar :: sidebarFragment"></div>

    <!-- ì½˜í…ì¸  -->
    <div class="content">
      <input type="hidden" name="username" id="username" th:value="${session.user.username}">
<!--      <input type="hidden" name="username" id="username" th:value="${username}">-->
      <div class="content-header">
        <h1>ì´ë ¥ì„œ ê´€ë¦¬</h1>
        <button class="add-resume-btn" onclick="addResume()">ìƒˆ ì´ë ¥ì„œ ì‘ì„±</button>
      </div>
      <div id="resumeList" class="resume-list"></div>
    </div>
  </div>

  <!-- í‘¸í„° -->
  <footer th:replace="/layout/footer :: footerFragment"></footer>
</div>
</body>
</html>
<script>
  let resumes = []; // ì´ë ¥ì„œ ë°ì´í„°ë¥¼ ì €ì¥
  const username = document.getElementById("username").value;

  window.onload = function () {
    fetchResumes();
  };

  // ì´ë ¥ì„œë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
  function fetchResumes() {
    api.get(`/api/v1/resume/list?username=${username}`)
            .then(response => {
              resumes = response.body; // ì„œë²„ì—ì„œ ë°ì´í„° ìˆ˜ì‹ 
              renderResumes();
            })
            .catch(error => {
              console.error("ì´ë ¥ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
              alert("ì´ë ¥ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            });
  }

  // ì´ë ¥ì„œë¥¼ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
  function addResume() {
    if (resumes.length >= 5) {
      alert("ì´ë ¥ì„œëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      return;
    }
    location.href = "/resume/reg";
  }

  // ì´ë ¥ì„œë¥¼ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
  function deleteResume(index) {
    if (confirm("ì´ ì´ë ¥ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
      api.delete(`/api/v1/resume/${index}`)
              .then(() => {
                resumes.splice(index, 1);
                alert("ì´ë ¥ì„œë¥¼ ì‚­ì œí•˜ì˜€ìŠµë‹ˆë‹¤.");
                location.reload();
              })
              .catch(error => {
                console.error("ì´ë ¥ì„œ ì‚­ì œ ì‹¤íŒ¨:", error);
                alert("ì´ë ¥ì„œë¥¼ ì‚­ì œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
              });
    }
  }

  // ì´ë ¥ì„œ ëª©ë¡ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
  function renderResumes() {
    const resumeList = document.getElementById("resumeList");
    resumeList.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì œê±°

    //  ì´ë ¥ì„œ í‘œì‹œ
    resumes.forEach((resume, index) => {
              const resumeItem = createResumeCard(resume, false, index);
              resumeList.appendChild(resumeItem);
            });
  }

  // ì´ë ¥ì„œ ì¹´ë“œë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
  function createResumeCard(resume, isRepresentative, index) {
    const resumeItem = document.createElement("div");
    resumeItem.className = "resume-item" + (isRepresentative ? " representative" : "");

    resumeItem.innerHTML = `
      <div>
        <h2>${resume.isPrimary==="Y" ? "ğŸŒŸ [ëŒ€í‘œ ì´ë ¥ì„œ] " : ""}${resume.title}</h2>
        <p>í¬ë§ ì§€ì—­: ${resume.wishArea}</p>
        <p>í¬ë§ ì—°ë´‰: ${resume.wishSalary}ë§Œì›</p>
        <p>í¬ë§ ê·¼ë¬´ ì‹œê°„: ${resume.wishTime}</p>
        <p>í¬ë§ ì§ë¬´: ${resume.workCode}</p>
      </div>
      <div>
        ${resume.isPrimary !== "Y" ? `<button onclick="setRepresentative(${resume.resumeNo})">ëŒ€í‘œë¡œ ì„¤ì •</button>` : ""}
        <button onclick="editResume(${resume.resumeNo})">í¸ì§‘</button>
        <button onclick="deleteResume(${resume.resumeNo})">ì‚­ì œ</button>
      </div>
    `;
    return resumeItem;
  }
  // ëŒ€í‘œ ì´ë ¥ì„œë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
  function setRepresentative(index) {
    const username = document.getElementById("username").value;

    api.post(`/api/v1/resume/primary?username=${username}&resumeNo=${index}`)
            .then(response => {
              alert(response.body);
              location.reload(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            })
            .catch(error => {
              console.error('ëŒ€í‘œ ì´ë ¥ì„œ ì„¤ì • ì‹¤íŒ¨:', error);
              alert('ëŒ€í‘œ ì´ë ¥ì„œ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });

  }
  // ì´ë ¥ì„œë¥¼ ìˆ˜ì •í•˜ëŠ” í•¨ìˆ˜
  function editResume(resumeNo) {
    location.href = `/resume/modify/${resumeNo}`;
  }
</script>
